<!DOCTYPE html>
<html>
<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.0/full/pyodide.js"></script>
  <script src="../../pyjamas/pjs.js"></script>
</head>

<body style="background-color: black; color: white; font-family: monospace;">
<h1>Interactive Python</h1>
<p id="output"></p>
<div id="status"" style="white-space: pre-wrap;"> </div><br>
<svg id="figure" width="800" height="800" style="border: 1px solid black; background-color: white;"></svg>

<script>

function update_simulation() {
    // update physics simulation
    pjs.run("agent.step(mouse[1])").then(() => {
            agent_positions = pjs.get("agent.x").toJs();
            for (let i = 0; i < agent_positions.length; i++) {
                agent = document.getElementById("agent_"+i);
                agent.setAttribute("cy", Math.trunc( agent_positions[i] ));
            }
        })
}

async function main_spring() {
    // set "status" as the standard output DOM element.
    await pjs.init("status", {flush:true}); 
    // run script
	await pjs.fetch_and_run('script.py');
	// display instructions
	pjs.stdout.print("Can you stabilise invidiual balls via vertical mouse movements on the canvas?", {prefix: ""});
    
    // create object representations
    var svg = document.getElementById("figure");
    const num_objects = pjs.get("agent.num_objects");
    const width = svg.width.baseVal.value; //svg.getBBox().width;
    const distance = Math.trunc( width / (num_objects + 1) );
    for (var i = 0; i < num_objects; i++) {
        var circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute('cx', (i+1) * distance);
        circle.setAttribute('cy', 0);
        circle.setAttribute('r', 10);
        circle.setAttribute('id', "agent_"+i);
        // random color
        circle.setAttribute('style', 'fill: #'+Math.floor(Math.random()*16777215).toString(16) );
        svg.appendChild(circle);
    }
    
    //attach mouse callback to svg
    svg.onmousemove = function(event){
        const box = event.currentTarget.getBoundingClientRect();
        const mouse = [
            event.clientX - box.left,
            event.clientY - box.top
        ];
        pjs.run("mouse = np.array([" + mouse.toString() + "])")
    };
    
    // start update loop
    setInterval(update_simulation, 10);
}

main_spring();

</script>

</body>
</html>